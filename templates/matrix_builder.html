<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Matrix Construction & Optimization</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body {
      background: url("https://imgtu.com/uploads/qedut7hc/r-background.webp") center / cover no-repeat;
      font-family: Arial, sans-serif;
    }
    nav {
      display: flex; align-items: center; background-color: #2b78d4;
      padding: 0 20px; height: 40px;
    }
    nav img { height: 30px; margin-right: 10px; }
    nav .brand { font-size: 18px; font-weight: bold; color: white; margin-right: 30px; }
    nav a { color: white; text-decoration: none; margin: 0 12px; font-weight: bold; }
    nav a:hover { text-decoration: underline; }

    .custom-analysis-btn { background-color:#2b78d4; border-color:#2b78d4; color:white; font-weight:bold; }
    .custom-analysis-btn:hover { background-color:#1a5bbf; border-color:#1a5bbf; }
    .btn-primary { background-color:#86DADE; border-color:#86DADE; }
    .btn-primary:hover { background-color:#1a5bbf; border-color:#1a5bbf; }
    .card-header { background-color:#86DADE; color:black; font-weight:bold; }

    .card-body{padding:1.25rem;}
    .sub-card{margin-top:1rem;border:1px solid #dee2e6;border-radius:.5rem;}
    .sub-card-header{background-color:#f8f9fa;padding:.6rem 1rem;border-bottom:1px solid #dee2e6;border-top-left-radius:.5rem;border-top-right-radius:.5rem;}
    .sub-card-body{padding:1rem;}
    .small-muted{font-size:.9rem;color:#6c757d;}
    .spinner-gap{gap:.5rem;align-items:center;}
    .preview-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1rem;}
    .result-img{width:100%;height:auto;border:1px solid #dee2e6;border-radius:.5rem;}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Liberation Mono","Courier New",monospace;background:#f8f9fa;border:1px solid #e9ecef;border-bottom-width:2px;border-radius:.25rem;padding:.1rem .35rem;}
    .input-group > .form-control[readonly] { background-color: #fff; }
    /* 控制下拉菜单整体 */
.dropdown-menu {
  min-width: 220px;       /* 保证有足够宽度，不会被文字撑破 */
  border-radius: 6px;     /* 圆角更美观 */
  overflow: hidden;       /* 避免 hover 颜色超出边框 */
}

/* 控制下拉项 */
.dropdown-menu .dropdown-item {
  font-size: 15px;
  font-weight: bold;
  font-family: "Microsoft YaHei", Arial, sans-serif;
  color: #1a3d7c;
  white-space: nowrap;    /* 避免换行导致错位 */
}

/* hover 样式（背景色不会溢出） */
.dropdown-menu .dropdown-item:hover {
  background-color: #e6f0ff;  /* 自定义 hover 背景色 */
  color: #0d2a57;
}

  </style>
</head>
<body>

  <!-- 顶部导航栏 -->
  <nav class="navbar navbar-expand-lg" style="background-color:#2b78d4;">
    <img src="https://imgtu.com/uploads/qi8ssrpb/t-file_7142b8.webp" alt="MS2NMF logo">
    <span class="brand">MS2NMF</span>

    <div class="collapse navbar-collapse">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link text-white" href="/">Home</a></li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle text-white" href="#" id="analysisDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            Analysis
          </a>
          <ul class="dropdown-menu" aria-labelledby="analysisDropdown">
            <li><a class="dropdown-item" href="/mass_spectrometry">Data Preprocessing</a></li>
            <li><a class="dropdown-item" href="/matrix_builder">Matrix Construction & Optimization</a></li>
            <li><a class="dropdown-item" href="/nmf">NMF Decomposition & Visualization</a></li>
          </ul>
        </li>
        <li class="nav-item"><a class="nav-link text-white" href="#">About</a></li>
        <li class="nav-item"><a class="nav-link text-white" href="#">Contact</a></li>
      </ul>
    </div>
  </nav>

  <!-- 页面主体 -->
  <div class="container mt-4">
    <h2 class="mb-4 text-center" style="color:#1a3d7c;">Matrix Construction & Optimization</h2>

    <!-- 主表单：MGF → Step①–⑥ -->
    <div class="card mb-4">
      <div class="card-header"><h5 class="mb-0">Matrix Construction</h5></div>
      <div class="card-body">
        <form id="matrixBuilderForm" enctype="multipart/form-data">
          <!-- 数据准备 -->
          <div class="sub-card">
            <div class="sub-card-header"><h6 class="mb-0">Data Preparation (MGF)</h6></div>
            <div class="sub-card-body">
              <div class="input-group">
                <label class="input-group-text btn btn-primary" for="mgfFile">Choose File</label>
                <input type="file" class="d-none" id="mgfFile" name="mgf_file" accept=".mgf,.mgf.gz" required>
                <input class="form-control" id="mgfFileName" value="No file chosen" readonly>
              </div>
            </div>
          </div>

          <!-- 分箱 -->
          <div class="sub-card">
            <div class="sub-card-header"><h6 class="mb-0">m/z Binning</h6></div>
            <div class="sub-card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="bin_size" class="form-label">Bin size (Da)</label>
                  <input type="number" step="0.01" class="form-control" id="bin_size" name="bin_size" value="0.01" required>
                </div>
              </div>
            </div>
          </div>

          <!-- 碎片筛选 -->
          <div class="sub-card">
            <div class="sub-card-header"><h6 class="mb-0">Rule-based Fragment Filtering</h6></div>
            <div class="sub-card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="tolerance" class="form-label">Tolerance (Da)</label>
                  <input type="number" step="0.01" class="form-control" id="tolerance" name="tolerance" value="0.02" required>
                </div>
              </div>
              <div class="small-muted mt-1"><strong>Elemental Composition：</strong>CH or CHO</div>
              <div class="small-muted"><strong>Structural Ions：</strong>[M+H]+、[M+Na]+、[M+NH4]+、[M+H-H2O]+、[M+H-2H2O]+</div>
              <div class="small-muted"><strong>Structural Mass Differences：</strong>Na：21.981942，NH3：17.026547，H2O：18.010565</div>
            </div>
          </div>

          <button type="submit" class="btn custom-analysis-btn mt-4">Start Analysis</button>
        </form>
        <div id="result" class="mt-3"></div>
      </div>
    </div>

    <!-- 功能①：频率+谷点 -->
    <div class="card mb-4">
      <div class="card-header"><h5 class="mb-0">Frequency-based Adaptive Filtering</h5></div>
      <div class="card-body">
        <div class="sub-card">
          <div class="sub-card-header"><h6 class="mb-0">Upload Step 6 Intensity Matrix (CSV)</h6></div>
          <div class="sub-card-body">
            <div class="input-group">
              <label class="input-group-text btn btn-primary" for="sharedCsvFile">Choose File</label>
              <input type="file" class="d-none" id="sharedCsvFile" accept=".csv" required>
              <input class="form-control" id="sharedCsvFileName" value="No file chosen" readonly>
            </div>
          </div>
        </div>

        <form id="freqValleyForm" class="mt-3">
          <div class="sub-card">
            <div class="sub-card-header"><h6 class="mb-0">Description</h6></div>
            <div class="sub-card-body">
              <div class="small-muted">
                <ul class="mb-0">
                  Use the uploaded CSV to calculate fragment frequencies. The smoothed distribution curve defines adaptive m/z intervals.
                  <li>Stricter cutoffs at low m/z remove noise.</li>
                  <li>Relaxed thresholds at high m/z preserve rare informative ions.</li>
                  This balances denoising with signal preservation for structurally relevant features.
                </ul>
              </div>
            </div>
          </div>
          <input type="hidden" name="bin20_quantile" value="0.999">
          <input type="hidden" name="bin_size_da" value="20">
          <input type="hidden" name="spline_s" value="0.05">
          <button type="submit" class="btn custom-analysis-btn mt-3">Run</button>
        </form>
        <div id="fv_result" class="mt-3"></div>
      </div>
    </div>

    <!-- 功能②：分段筛选 -->
    <div class="card mb-5">
      <div class="card-header"><h5 class="mb-0">Partition Filtering (by Frequency & Threshold)</h5></div>
      <div class="card-body">
        <form id="segFilterForm">
          <div class="sub-card">
            <div class="sub-card-header"><h6 class="mb-0">Partition Threshold Parameters</h6></div>
            <div class="sub-card-body">
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label class="form-label">m/z split point</label>
                  <input type="number" step="1" class="form-control" name="mz_split_threshold" value="300" required>
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">high m/z frequency threshold</label>
                  <input type="number" step="0.001" class="form-control" name="high_freq_rate" value="0.01" required>
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">low m/z frequency threshold</label>
                  <input type="number" step="0.001" class="form-control" name="low_freq_rate" value="0.1" required>
                </div>
              </div>
            </div>
          </div>
          <button type="submit" class="btn custom-analysis-btn mt-3">Start Analysis</button>
        </form>
        <div id="sf_result" class="mt-3"></div>
      </div>
    </div>
  </div>

<script>
  // —— 工具：把 *_filename 渲染成下载列表 + PNG 预览 ——
  function renderFiles($container, result){
    const files = result || {};
    let listHtml = '', imgHtml = '';

    Object.keys(files).forEach(key=>{
      const name = files[key];
      if(typeof name !== 'string') return;
      if(!/_filename$/i.test(key)) return;  // 只渲染 *_filename

      if(/\.(png|jpg|jpeg|gif)$/i.test(name)){
        imgHtml += `
          <div class="mb-3">
            <a class="d-block mb-1" href="/download/${encodeURIComponent(name)}" download>download ${name}</a>
            <img class="result-img" src="/download/${encodeURIComponent(name)}" alt="${name}"/>
          </div>`;
      }else{
        listHtml += `<li><a class="btn btn-link p-0" href="/download/${encodeURIComponent(name)}" download>${name}</a></li>`;
      }
    });

    $container.html(`
      <div class="alert alert-success">
        <h6 class="mb-2"></h6>
        ${listHtml ? `<ul class="mb-3">${listHtml}</ul>` : '<div class="small-muted mb-2"></div>'}
        ${imgHtml ? `<div class="preview-grid">${imgHtml}</div>` : '<div class="small-muted"></div>'}
      </div>
    `);
  }

  // —— 主表单：/process_matrix_builder ——
  $('#matrixBuilderForm').on('submit', function(e){
    e.preventDefault();
    const formData = new FormData(this);
    $('#result').html('<div class="alert alert-info d-flex spinner-gap"><div class="spinner-border spinner-border-sm"></div><div>Currently executing Step ①–⑥...</div></div>');
    $.ajax({
      url:'/process_matrix_builder', type:'POST',
      data:formData, processData:false, contentType:false, dataType:'json',
      success: resp=>{
        if(resp && resp.error){ $('#result').html(`<div class="alert alert-danger">${resp.error}</div>`); return; }
        renderFiles($('#result'), resp.result);
      },
      error: xhr=>{
        const msg = (xhr.responseJSON && xhr.responseJSON.error) || 'Processing failed';
        $('#result').html(`<div class="alert alert-danger">${msg}</div>`);
      }
    });
  });

  // —— 功能①：/freq_valley_analysis ——
  $('#freqValleyForm').on('submit', function(e){
    e.preventDefault();
    const f=document.getElementById('sharedCsvFile').files[0];
    if(!f){ $('#fv_result').html('<div class="alert alert-warning">Please upload CSV</div>'); return; }
    const fd=new FormData();
    fd.append('intensity_matrix_file', f);
    fd.append('bin_size_da', '20');
    fd.append('bin20_quantile', '0.999');
    fd.append('spline_s', '0.05');

    $('#fv_result').html('<div class="alert alert-info d-flex spinner-gap"><div class="spinner-border spinner-border-sm"></div><div>Calculating frequency and segment points...</div></div>');
    $.ajax({
      url:'/freq_valley_analysis', type:'POST', data:fd, processData:false, contentType:false, dataType:'json',
      success: resp=>{
        if(resp && resp.error){ $('#fv_result').html(`<div class="alert alert-danger">${resp.error}</div>`); return; }
        // 渲染下载与图
        renderFiles($('#fv_result'), resp.result);
        // 在结果顶部显示谷点列表
        if(resp.result && Array.isArray(resp.result.valley_mz_list)){
          const formatted = resp.result.valley_mz_list.map(v => Number(v).toFixed(4));
          $('#fv_result').prepend(`
            <div class="alert alert-secondary mb-3">
              <strong>Valley m/z list:</strong>
              <code>[${formatted.join(', ')}]</code>
            </div>
          `);
        }
      },
      error: xhr=>{
        const msg=(xhr.responseJSON && xhr.responseJSON.error) || 'error';
        $('#fv_result').html(`<div class="alert alert-danger">${msg}</div>`);
      }
    });
  });

  // —— 功能②：/segmented_frequency_filter ——
  $('#segFilterForm').on('submit', function(e){
    e.preventDefault();
    const f=document.getElementById('sharedCsvFile').files[0];
    if(!f){ $('#sf_result').html('<div class="alert alert-warning">Please upload CSV</div>'); return; }
    const fd=new FormData(this);
    fd.append('intensity_matrix_file', f);

    $('#sf_result').html('<div class="alert alert-info d-flex spinner-gap"><div class="spinner-border spinner-border-sm"></div><div>Segmented screening is in progress...</div></div>');
    $.ajax({
      url:'/segmented_frequency_filter', type:'POST', data:fd, processData:false, contentType:false, dataType:'json',
      success: resp=>{
        if(resp && resp.error){ $('#sf_result').html(`<div class="alert alert-danger">${resp.error}</div>`); return; }
        renderFiles($('#sf_result'), resp.result);
      },
      error: xhr=>{
        const msg=(xhr.responseJSON && xhr.responseJSON.error) || 'error';
        $('#sf_result').html(`<div class="alert alert-danger">${msg}</div>`);
      }
    });
  });

  // —— 文件名联动（MGF / CSV） ——
  document.getElementById('mgfFile').addEventListener('change', function(){
    document.getElementById('mgfFileName').value = this.files[0]?.name || 'No file chosen';
  });
  document.getElementById('sharedCsvFile').addEventListener('change', function(){
    document.getElementById('sharedCsvFileName').value = this.files[0]?.name || 'No file chosen';
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
